name: Mirror and run GitLab CI

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Create GitLab repository
        uses: dpacmittal/create-repo-action@v1.0.0
        with:
          gitlab-token: ${{ secrets.GITLAB_TOKEN }}
          repo-name: ${{ github.repository_name }}
          namespace: ${{ github.repository_owner }}
        id: create_repo
      - name: Make GitLab repo private if GitHub repo is private
        if: github.event.repository.private == true
        uses: git-actions/gitlab-set-visibility-action@v1.0.1
        with:
          gitlab-token: ${{ secrets.GITLAB_TOKEN }}
          gitlab-host: gitlab.com
          gitlab-project: ${{ github.repository_owner }}/${{ github.repository_name }}
          visibility: 'private'
      - name: Make GitLab repo public if GitHub repo is public
        if: github.event.repository.private != true
        uses: git-actions/gitlab-set-visibility-action@v1.0.1
        with:
          gitlab-token: ${{ secrets.GITLAB_TOKEN }}
          gitlab-host: gitlab.com
          gitlab-project: ${{ github.repository_owner }}/${{ github.repository_name }}
          visibility: 'public'
      - name: Mirror GitHub repo to GitLab and trigger CI
        uses: SvanBoxel/gitlab-mirror-and-ci-action@master
        with:
          args: "https://gitlab.com/${{ github.repository_owner }}/${{ github.repository_name }}"
        env:
          FORCE_PUSH: "true"
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_HOSTNAME: "gitlab.com"
          GITLAB_USERNAME: ${{ secrets.GITLAB_USERNAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
